<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Communication Details Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Submit Communication Details</h1>
    <form id="communication-form">
        <!-- Required Fields -->
        <label for="MessageID">Message ID:</label>
        <input type="text" id="MessageID" name="MessageID" required><br><br>

        <label for="SenderDetails">Sender Details:</label>
        <input type="text" id="SenderDetails" name="SenderDetails" required><br><br>

        <label for="RecipientDetails">Recipient Details:</label>
        <input type="text" id="RecipientDetails" name="RecipientDetails" required><br><br>

        <label for="Date">Date:</label>
        <input type="datetime-local" id="Date" name="Date" required><br><br>

        <label for="Medium">Medium:</label>
        <input type="text" id="Medium" name="Medium" required><br><br>

        <label for="SourceLocation">Source Location:</label>
        <input type="text" id="SourceLocation" name="SourceLocation"><br><br>

        <label for="DestinationLocation">Destination Location:</label>
        <input type="text" id="DestinationLocation" name="DestinationLocation"><br><br>

        <label for="CommunicationType">Communication Type:</label>
        <input type="text" id="CommunicationType" name="CommunicationType"><br><br>

        <label for="NumberOfAdults">Number of Adults:</label>
        <input type="number" id="NumberOfAdults" name="NumberOfAdults"><br><br>

        <label for="NumberOfChildren">Number of Children:</label>
        <input type="number" id="NumberOfChildren" name="NumberOfChildren"><br><br>

        <label for="EventType">Event Type:</label>
        <input type="text" id="EventType" name="EventType"><br><br>

        <label for="EventNotes">Event Notes:</label>
        <textarea id="EventNotes" name="EventNotes"></textarea><br><br>

        <label for="VictimEntity">Victim Entity:</label>
        <input type="text" id="VictimEntity" name="VictimEntity"><br><br>

        <label for="VictimAction">Victim Action:</label>
        <input type="text" id="VictimAction" name="VictimAction"><br><br>

        <label for="VictimOutcome">Victim Outcome:</label>
        <input type="text" id="VictimOutcome" name="VictimOutcome"><br><br>

        <label for="OtherEntityName">Other Entity Name:</label>
        <input type="text" id="OtherEntityName" name="OtherEntityName"><br><br>

        <label for="OtherEntityAction">Other Entity Action:</label>
        <input type="text" id="OtherEntityAction" name="OtherEntityAction"><br><br>

        <label for="OtherEntityOutcome">Other Entity Outcome:</label>
        <input type="text" id="OtherEntityOutcome" name="OtherEntityOutcome"><br><br>

        <label for="SpecificLocation">Specific Location:</label>
        <input type="text" id="SpecificLocation" name="SpecificLocation"><br><br>

        <label for="LocationContext">Location Context:</label>
        <textarea id="LocationContext" name="LocationContext"></textarea><br><br>

        <button type="submit">Submit</button>
    </form>

    <h2>Analytics</h2>

    <h3>Event Type Distribution</h3>
    <canvas id="eventTypeChart" width="400" height="200"></canvas>

    <h3>Communication Trends Over Time</h3>
    <canvas id="trendChart" width="400" height="200"></canvas>

    <h3>Medium Usage</h3>
    <canvas id="mediumChart" width="400" height="200"></canvas>

    <script>
        document.getElementById('communication-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            try {
                const response = await fetch('/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('Data submitted successfully!');
                    fetchAnalytics();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (err) {
                console.error(err);
                alert('Failed to submit data.');
            }
        });

        async function fetchAnalytics() {
            // Event Type Chart
            const eventTypeResponse = await fetch('/analytics/event_type');
            const eventTypeData = await eventTypeResponse.json();

            const eventLabels = eventTypeData.map(item => item.EventType);
            const eventCounts = eventTypeData.map(item => item.count);

            const eventCtx = document.getElementById('eventTypeChart').getContext('2d');
            new Chart(eventCtx, {
                type: 'pie',
                data: {
                    labels: eventLabels,
                    datasets: [{
                        data: eventCounts,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56']
                    }]
                }
            });

            // Trend Chart
            const trendResponse = await fetch('/analytics/trend');
            const trendData = await trendResponse.json();

            const trendLabels = trendData.map(item => item.communication_date);
            const trendCounts = trendData.map(item => item.count);

            const trendCtx = document.getElementById('trendChart').getContext('2d');
            new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: trendLabels,
                    datasets: [{
                        label: 'Number of Communications',
                        data: trendCounts,
                        borderColor: '#36A2EB',
                        fill: false
                    }]
                }
            });

            // Medium Usage Chart
            const mediumResponse = await fetch('/analytics/medium');
            const mediumData = await mediumResponse.json();

            const mediumLabels = mediumData.map(item => item.Medium);
            const mediumCounts = mediumData.map(item => item.count);

            const mediumCtx = document.getElementById('mediumChart').getContext('2d');
            new Chart(mediumCtx, {
                type: 'bar',
                data: {
                    labels: mediumLabels,
                    datasets: [{
                        label: 'Medium Usage',
                        data: mediumCounts,
                        backgroundColor: '#FFCE56'
                    }]
                }
            });
        }

        // Fetch analytics on page load
        fetchAnalytics();
    </script>
</body>
</html>
